<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung {{rechnung.nummer}} - {{studio.name}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: white;
            padding: 0;
            margin: 0;
        }
        
        .invoice-container {
            max-width: 21cm;
            margin: 0 auto;
            background: white;
            min-height: 29.7cm;
        }
        
        /* Professional Header */
        .professional-header {
            padding: 2rem;
            border-bottom: 2px solid #e2e8f0;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: start;
        }
        
        .studio-branding h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .studio-tagline {
            font-size: 1rem;
            color: #718096;
            margin-bottom: 1.5rem;
            font-style: italic;
        }
        
        .studio-contact {
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .studio-contact p {
            margin-bottom: 0.25rem;
            color: #4a5568;
        }
        
        .professional-links {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
        }
        
        .professional-links a {
            color: #4a5568;
            text-decoration: none;
            font-size: 0.85rem;
            border-bottom: 1px solid #cbd5e0;
            padding-bottom: 1px;
        }
        
        .credentials {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .credential-item {
            display: inline-block;
            background: #f7fafc;
            color: #4a5568;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.25rem 0.5rem 0.25rem 0;
            border: 1px solid #e2e8f0;
        }
        
        .invoice-meta {
            text-align: right;
        }
        
        .invoice-number {
            font-size: 1.8rem;
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .invoice-date {
            font-size: 1rem;
            color: #4a5568;
        }
        
        /* Project Overview */
        .project-overview {
            padding: 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .project-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        
        .project-period {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        
        .client-project-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .client-info h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .client-info p {
            margin-bottom: 0.25rem;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        .project-details h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .project-details p {
            margin-bottom: 0.25rem;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        /* Services Breakdown */
        .services-breakdown {
            padding: 2rem;
        }
        
        .services-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 2rem;
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .phase-section {
            margin: 2rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .phase-header {
            background: #2d3748;
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .phase-items {
            background: white;
        }
        
        .service-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .service-table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .service-table th:last-child {
            text-align: right;
        }
        
        .service-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .service-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #2d3748;
        }
        
        .service-table tr:last-child td {
            border-bottom: none;
        }
        
        /* IP Rights Section */
        .ip-rights {
            padding: 2rem;
            background: #fef5e7;
            border: 2px solid #f6ad55;
            margin: 2rem;
            border-radius: 8px;
        }
        
        .ip-rights h3 {
            color: #c05621;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
        }
        
        .rights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .rights-item h4 {
            color: #c05621;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .rights-item p {
            color: #744210;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .rights-notice {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #f6ad55;
            font-style: italic;
            color: #744210;
            font-size: 0.85rem;
        }
        
        /* Professional Reference */
        .professional-reference {
            padding: 2rem;
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            margin: 2rem;
            border-radius: 6px;
        }
        
        .reference-quote {
            font-style: italic;
            font-size: 1rem;
            color: #2d3748;
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        
        .reference-author {
            text-align: right;
            font-weight: 600;
            color: #2f855a;
            font-size: 0.9rem;
        }
        
        /* Delivery Information */
        .delivery-section {
            padding: 2rem;
            background: #edf2f7;
            border-radius: 8px;
            margin: 2rem;
        }
        
        .delivery-section h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .delivery-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .delivery-method h4 {
            color: #2d3748;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .delivery-method p {
            color: #4a5568;
            font-size: 0.85rem;
        }
        
        .file-formats {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
        }
        
        .file-formats h4 {
            color: #2d3748;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .format-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }
        
        .format-item {
            font-size: 0.8rem;
            color: #4a5568;
            padding: 0.25rem 0;
        }
        
        /* Summary Section */
        .summary {
            padding: 2rem;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
        }
        
        .summary h3 {
            color: #2d3748;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
        }
        
        .summary-table {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-collapse: collapse;
        }
        
        .summary-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95rem;
        }
        
        .summary-table td:first-child {
            color: #4a5568;
        }
        
        .summary-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #2d3748;
        }
        
        .discount-row {
            color: #38a169 !important;
        }
        
        .discount-row td {
            color: #38a169;
        }
        
        .total-row {
            border-top: 2px solid #2d3748;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .total-row td {
            color: #2d3748;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Legal Footer */
        .legal-footer {
            background: #2d3748;
            color: white;
            padding: 2rem;
        }
        
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .footer-section h4 {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .footer-section p {
            color: #cbd5e0;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        .footer-section strong {
            color: white;
        }
        
        .footer-notice {
            text-align: center;
            color: #a0aec0;
            font-size: 0.8rem;
            padding-top: 1.5rem;
            border-top: 1px solid #4a5568;
        }
        
        /* Print Optimization */
        @media print {
            /* A4 Page Setup */
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body {
                background: white;
                color: black;
                font-size: 10pt;
                line-height: 1.3;
            }
            
            .invoice-container {
                max-width: none;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            /* Table Optimization - CRITICAL UPDATE */
            table {
                break-inside: auto; /* Allow breaks for long tables */
            }
            
            thead {
                display: table-header-group; /* Repeat header on each page */
            }
            
            tr {
                break-inside: avoid; /* Never split table rows */
            }
            
            th, td {
                padding: 0.5rem 0.3rem; /* Compact for print */
                font-size: 9pt;
            }
            
            /* Header-Content binding */
            h1, h2, h3, h4 {
                break-after: avoid;
                orphans: 3;
                widows: 3;
            }
            
            /* Prevent orphans and widows */
            p, li, div {
                orphans: 2;
                widows: 2;
            }
            
            /* Compact spacing for print */
            .section {
                margin: 1rem 0;
            }
            
            /* B&W optimization */
            th {
                background: #f0f0f0 !important;
                border: 1px solid #000 !important;
            }
            
            /* Template-specific sections */
            .professional-header,
            .project-overview,
            .services-breakdown,
            .ip-rights,
            .delivery-section,
            .summary,
            .legal-footer {
                break-inside: avoid;
            }
            
            .phase-section {
                break-inside: avoid;
                margin: 1rem 0;
            }
            
            .portfolio-section {
                break-inside: avoid;
            }
            
            .legal-footer {
                background: white !important;
                color: black !important;
                border-top: 2px solid #000;
            }
            
            .footer-section h4 {
                color: black !important;
            }
            
            .footer-section p {
                color: black !important;
            }
            
            .footer-section strong {
                color: black !important;
            }
            
            .footer-notice {
                color: black !important;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .professional-header {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .client-project-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .service-table {
                font-size: 0.8rem;
            }
            
            .service-table th,
            .service-table td {
                padding: 0.5rem;
            }
            
            .rights-grid {
                grid-template-columns: 1fr;
            }
            
            .footer-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- Professional Header -->
        <header class="professional-header">
            <div class="studio-branding">
                <h1>{{studio.name}}</h1>
                <p class="studio-tagline">{{studio.tagline}}</p>
                <div class="studio-contact">
                    <p><strong>{{studio.inhaber}}</strong></p>
                    <p>{{studio.strasse}}</p>
                    <p>{{studio.plz}} {{studio.ort}}, {{studio.land}}</p>
                    <p>T: {{studio.telefon}}</p>
                    <p>E: {{studio.email}}</p>
                    <p>W: {{studio.web}}</p>
                    
                    <div class="professional-links">
                        <a href="{{studio.portfolio_url}}">Portfolio</a>
                        <a href="{{studio.linkedin_url}}">LinkedIn</a>
                    </div>
                    
                    <div class="credentials">
                        {{#each studio.credentials}}
                            <span class="credential-item">{{this}}</span>
                        {{/each}}
                    </div>
                </div>
            </div>
            
            <div class="invoice-meta">
                <div class="invoice-number">{{rechnung.nummer}}</div>
                <div class="invoice-date">{{rechnung.datum}}</div>
            </div>
        </header>
        
        <!-- Project Overview -->
        <section class="project-overview">
            <h2 class="project-title">{{project.name}}</h2>
            <p class="project-period">Projektlaufzeit: {{rechnung.projekt_zeitraum}}</p>
            
            <div class="client-project-grid">
                <div class="client-info">
                    <h3>Auftraggeber</h3>
                    <p><strong>{{kunde.firma}}</strong></p>
                    <p>{{kunde.ansprechpartner}}</p>
                    <p>{{kunde.strasse}}</p>
                    <p>{{kunde.plz}} {{kunde.ort}}</p>
                    <p>{{kunde.email}}</p>
                </div>
                
                <div class="project-details">
                    <h3>Projektdetails</h3>
                    <p><strong>Creative Brief:</strong> {{rechnung.brief_referenz}}</p>
                    <p><strong>Projekttyp:</strong> {{project.typ}}</p>
                    <p><strong>Branche:</strong> {{project.branche}}</p>
                    <p><strong>Projektphase:</strong> {{project.phase}}</p>
                </div>
            </div>
        </section>
        
        <!-- Services Breakdown -->
        <main class="services-breakdown">
            <h3 class="services-title">Leistungserbringung nach Projektphasen</h3>
            
            {{#each leistungen}}
            <section class="phase-section">
                <div class="phase-header">
                    Phase {{@index}}: {{phase}}
                </div>
                <div class="phase-items">
                    <table class="service-table">
                        <thead>
                            <tr>
                                <th>Leistungsbeschreibung</th>
                                <th>Einheit</th>
                                <th>Menge</th>
                                <th>Einzelpreis</th>
                                <th>Gesamtpreis</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each items}}
                            <tr>
                                <td>{{beschreibung}}</td>
                                <td>{{einheit}}</td>
                                <td>{{menge}}</td>
                                <td>€{{einzelpreis}}</td>
                                <td>€{{gesamt}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </section>
            {{/each}}
        </main>
        
        <!-- IP Rights Section -->
        <section class="ip-rights">
            <h3>Nutzungsrechte und geistiges Eigentum</h3>
            <div class="rights-grid">
                <div class="rights-item">
                    <h4>Nutzungsumfang</h4>
                    <p>{{nutzungsrechte.umfang}}</p>
                </div>
                <div class="rights-item">
                    <h4>Nutzungsdauer</h4>
                    <p>{{nutzungsrechte.dauer}}</p>
                </div>
                <div class="rights-item">
                    <h4>Bearbeitung & Änderung</h4>
                    <p>{{nutzungsrechte.bearbeitung}}</p>
                </div>
                <div class="rights-item">
                    <h4>Weitergabe & Lizenzierung</h4>
                    <p>{{nutzungsrechte.weitergabe}}</p>
                </div>
            </div>
            <div class="rights-notice">
                <strong>Wichtiger Hinweis:</strong> {{nutzungsrechte.archivierung}}
                Das Urheberrecht verbleibt beim Urheber gemäß österreichischem Urheberrechtsgesetz.
            </div>
        </section>
        
        <!-- Professional Reference -->
        <section class="professional-reference">
            <p class="reference-quote">"{{testimonial.quote}}"</p>
            <p class="reference-author">— {{testimonial.author}}</p>
        </section>
        
        <!-- Delivery Information -->
        <section class="delivery-section">
            <h3>Projektlieferung und Dateienübergabe</h3>
            <div class="delivery-details">
                <div class="delivery-method">
                    <h4>Liefermethode</h4>
                    <p>{{lieferung.methode}}</p>
                    <p><strong>Download:</strong> {{lieferung.link}}</p>
                    <p><strong>Zugangsschlüssel:</strong> {{lieferung.passwort}}</p>
                </div>
                
                <div class="file-formats">
                    <h4>Dateiformate und Deliverables</h4>
                    <div class="format-list">
                        {{#each lieferung.dateien}}
                            <div class="format-item">{{this}}</div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Summary -->
        <section class="summary">
            <h3>Rechnungszusammenfassung</h3>
            
            <table class="summary-table">
                <tr>
                    <td>Discovery & Strategy</td>
                    <td>€{{zusammenfassung.subtotal_discovery}}</td>
                </tr>
                <tr>
                    <td>Design Development</td>
                    <td>€{{zusammenfassung.subtotal_design}}</td>
                </tr>
                <tr>
                    <td>Application Design</td>
                    <td>€{{zusammenfassung.subtotal_application}}</td>
                </tr>
                <tr>
                    <td>Brand Guidelines</td>
                    <td>€{{zusammenfassung.subtotal_guidelines}}</td>
                </tr>
                <tr>
                    <td>Zusatzleistungen</td>
                    <td>€{{zusammenfassung.subtotal_extras}}</td>
                </tr>
                <tr class="discount-row">
                    <td>{{zusammenfassung.rabatt_beschreibung}} (-{{zusammenfassung.rabatt_prozent}}%)</td>
                    <td>-€{{zusammenfassung.rabatt_betrag}}</td>
                </tr>
                <tr>
                    <td>Zwischensumme (netto)</td>
                    <td>€{{zusammenfassung.summe_netto}}</td>
                </tr>
                <tr>
                    <td>Umsatzsteuer (20%)</td>
                    <td>€{{zusammenfassung.ust_20}}</td>
                </tr>
                <tr class="total-row">
                    <td>Rechnungsbetrag (brutto)</td>
                    <td>€{{zusammenfassung.summe_brutto}}</td>
                </tr>
            </table>
        </section>
        
        <!-- Legal Footer -->
        <footer class="legal-footer">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>Zahlungskonditionen</h4>
                    <p><strong>Zahlungsziel:</strong> {{rechnung.zahlungsziel}}</p>
                    <p><strong>Bank:</strong> {{studio.bank}}</p>
                    <p><strong>IBAN:</strong> {{studio.iban}}</p>
                    <p><strong>BIC:</strong> {{studio.bic}}</p>
                </div>
                
                <div class="footer-section">
                    <h4>Steuerliche Angaben</h4>
                    <p><strong>UID-Nummer:</strong> {{studio.uid}}</p>
                    <p>Einzelunternehmer gemäß §6 UStG</p>
                    <p>Mitglied der Wirtschaftskammer Österreich</p>
                </div>
                
                <div class="footer-section">
                    <h4>Rechtliches</h4>
                    <p>Erfüllungsort und Gerichtsstand: {{studio.ort}}</p>
                    <p>Es gilt österreichisches Recht</p>
                    <p>Alle Preise verstehen sich in Euro (EUR)</p>
                </div>
            </div>
            
            <div class="footer-notice">
                Diese Rechnung entspricht den Bestimmungen des österreichischen Umsatzsteuergesetzes (UStG) §11
                und wurde ordnungsgemäß erstellt für steuerliche Zwecke.
            </div>
        </footer>
    </div>
</body>
</html>