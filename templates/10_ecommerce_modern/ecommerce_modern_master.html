<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung {{bestellung.rechnungsnummer}} - {{shop.name}}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, Helvetica, sans-serif; 
            line-height: 1.4; 
            color: #000; 
            background: #fff;
        }
        .container { 
            max-width: 210mm; 
            margin: 0 auto; 
            background: white; 
            padding: 0;
        }
        
        /* Header */
        .header {
            border-bottom: 2px solid #333;
            padding: 1.5rem 0 1rem 0;
            margin-bottom: 1rem;
        }
        .shop-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
        }
        .shop-name { 
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #000;
            margin-bottom: 0.3rem;
        }
        .shop-claim { 
            font-size: 0.9rem; 
            color: #666;
            font-style: italic;
        }
        .company-details {
            text-align: right;
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        /* Invoice Info */
        .invoice-header {
            margin: 1.5rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .invoice-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.5rem;
        }
        .invoice-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
        }
        .meta-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 0.2rem;
        }
        .meta-label {
            font-weight: 600;
        }
        
        /* Customer Info */
        .customer-section {
            margin: 1.5rem 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .address-block {
            border: 1px solid #ddd;
            padding: 1rem;
        }
        .address-block h3 {
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.3rem;
        }
        .address-content {
            line-height: 1.3;
            font-size: 0.9rem;
        }
        
        /* Products */
        .products-section {
            margin: 2rem 0;
        }
        .section-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #000;
        }
        .products-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            margin-bottom: 1rem;
        }
        .products-table th,
        .products-table td {
            border: 1px solid #ddd;
            padding: 0.7rem 0.5rem;
            text-align: left;
            vertical-align: top;
            font-size: 0.9rem;
        }
        .products-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #000;
        }
        .products-table .qty-col,
        .products-table .price-col,
        .products-table .total-col {
            text-align: right;
            width: 80px;
        }
        .products-table .article-col {
            width: 100px;
        }
        .product-name {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .product-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.2;
        }
        
        /* Summary */
        .summary-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
        }
        .summary-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #000;
        }
        .summary-table {
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            border-collapse: collapse;
        }
        .summary-table td {
            padding: 0.4rem 0.8rem;
            border-bottom: 1px dotted #ccc;
        }
        .summary-label {
            text-align: right;
            font-weight: normal;
        }
        .summary-value {
            text-align: right;
            font-weight: 600;
            width: 100px;
        }
        .summary-total {
            border-top: 2px solid #000;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* OSS Information */
        .oss-section {
            margin: 1.5rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        .oss-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #000;
        }
        .oss-content {
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        /* Shipping & Return Information */
        .shipping-return-section {
            margin: 1.5rem 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .info-block {
            border: 1px solid #ddd;
            padding: 1rem;
        }
        .info-block h3 {
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.3rem;
        }
        .info-content {
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        /* Footer */
        .footer {
            margin-top: 2rem;
            padding: 1.5rem;
            border-top: 2px solid #333;
            background: #f9f9f9;
        }
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        .footer-section h4 {
            color: #000;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            font-weight: bold;
        }
        .footer-section p,
        .footer-section div {
            font-size: 0.85rem;
            color: #333;
            line-height: 1.4;
            margin: 0.2rem 0;
        }
        
        /* Print Styles */
        @media print {
            /* A4 Page Setup */
            @page {
                size: A4;
                margin: 15mm;
            }
            
            body { 
                background: white; 
                font-size: 10pt;
                line-height: 1.3;
            }
            
            .container { 
                max-width: none; 
                margin: 0; 
                padding: 0;
            }
            
            /* Critical Sections - Never Break */
            .header,
            .invoice-header,
            .customer-section,
            .summary-section,
            .oss-section,
            .shipping-return-section,
            .footer {
                break-inside: avoid;
            }
            
            /* Keep headers with content */
            h1, h2, h3, h4, .section-title, .summary-title, .oss-title {
                break-after: avoid;
                orphans: 3;
                widows: 3;
            }
            
            /* Table Optimization */
            .products-table {
                break-inside: auto; /* Allow breaks for long tables */
                margin-bottom: 1rem;
            }
            
            .products-table thead {
                display: table-header-group; /* Repeat header on each page */
            }
            
            .products-table tr {
                break-inside: avoid; /* Never split table rows */
            }
            
            .products-table th,
            .products-table td {
                padding: 0.5rem 0.3rem; /* Compact for print */
                font-size: 9pt;
            }
            
            /* Summary Table - Keep together */
            .summary-table {
                break-inside: avoid;
            }
            
            /* Address blocks - Keep together */
            .address-block,
            .info-block {
                break-inside: avoid;
                margin-bottom: 1rem;
            }
            
            /* Prevent orphans and widows */
            p, li, div {
                orphans: 2;
                widows: 2;
            }
            
            /* Footer always at bottom */
            .footer {
                break-inside: avoid;
                margin-top: 1rem;
            }
            
            /* Hide elements not needed in print */
            .no-print { 
                display: none; 
            }
            
            /* Compact spacing for print */
            .customer-section,
            .products-section,
            .summary-section,
            .oss-section,
            .shipping-return-section {
                margin: 1rem 0;
            }
            
            /* Ensure good contrast in B&W */
            .products-table th {
                background: #f0f0f0 !important;
                border: 1px solid #000 !important;
            }
            
            .summary-total {
                border-top: 2px solid #000 !important;
            }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .customer-section { grid-template-columns: 1fr; gap: 1rem; }
            .shipping-return-section { grid-template-columns: 1fr; gap: 1rem; }
            .shop-info { flex-direction: column; text-align: center; }
            .company-details { text-align: center; margin-top: 1rem; }
            .invoice-meta { grid-template-columns: 1fr; }
            .footer-grid { grid-template-columns: 1fr; }
            .products-table { font-size: 0.8rem; }
            .products-table .qty-col,
            .products-table .price-col,
            .products-table .total-col { width: 60px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="shop-info">
                <div>
                    <div class="shop-name">{{shop.name}}</div>
                    <div class="shop-claim">{{shop.claim}}</div>
                </div>
                <div class="company-details">
                    <div>{{shop.strasse}}</div>
                    <div>{{shop.plz}} {{shop.ort}}, {{shop.land}}</div>
                    <div>Tel: {{shop.telefon}}</div>
                    <div>E-Mail: {{shop.email}}</div>
                    <div>UID: {{shop.uid}}</div>
                    <div>{{shop.firmenbuch}}</div>
                </div>
            </div>
        </div>
        
        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="invoice-title">RECHNUNG</div>
            <div class="invoice-meta">
                <div class="meta-item">
                    <span class="meta-label">Rechnungsnummer:</span>
                    <span>{{bestellung.rechnungsnummer}}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Rechnungsdatum:</span>
                    <span>{{bestellung.rechnungsdatum}}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Bestellnummer:</span>
                    <span>{{bestellung.bestellnummer}}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Bestelldatum:</span>
                    <span>{{bestellung.bestelldatum}}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Kundennummer:</span>
                    <span>{{kunde.kundennummer}}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Zahlungsstatus:</span>
                    <span>{{bestellung.zahlungsstatus}}</span>
                </div>
            </div>
        </div>
        
        <!-- Customer Section -->
        <div class="customer-section">
            <div class="address-block">
                <h3>Rechnungsadresse</h3>
                <div class="address-content">
                    <div>{{kunde.anrede}} {{kunde.vorname}} {{kunde.nachname}}</div>
                    <div>{{kunde.rechnungsadresse.strasse}}</div>
                    <div>{{kunde.rechnungsadresse.plz}} {{kunde.rechnungsadresse.ort}}</div>
                    <div>{{kunde.rechnungsadresse.land}}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                        E-Mail: {{kunde.email}}
                    </div>
                </div>
            </div>
            <div class="address-block">
                <h3>Lieferadresse</h3>
                <div class="address-content">
                    <div>{{kunde.lieferadresse.empfaenger}}</div>
                    <div>{{kunde.lieferadresse.strasse}}</div>
                    <div>{{kunde.lieferadresse.plz}} {{kunde.lieferadresse.ort}}</div>
                    <div>{{kunde.lieferadresse.land}}</div>
                </div>
            </div>
        </div>
        
        <!-- Products -->
        <div class="products-section">
            <h2 class="section-title">Artikel / Leistungen</h2>
            <table class="products-table">
                <thead>
                    <tr>
                        <th class="article-col">Art.-Nr.</th>
                        <th>Bezeichnung</th>
                        <th class="qty-col">Menge</th>
                        <th class="price-col">Einzelpreis</th>
                        <th class="price-col">Rabatt</th>
                        <th class="price-col">MwSt.</th>
                        <th class="total-col">Gesamt</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each artikel}}
                    <tr>
                        <td>{{artikelnummer}}</td>
                        <td>
                            <div class="product-name">{{bezeichnung}}</div>
                            <div class="product-details">
                                {{#if ean}}EAN: {{ean}}{{/if}}
                                {{#if farbe}} | Farbe: {{farbe}}{{/if}}
                                {{#if groesse}} | Größe: {{groesse}}{{/if}}
                                {{#if herkunft}}<br>{{herkunft}}{{/if}}
                            </div>
                        </td>
                        <td class="qty-col">{{menge}}</td>
                        <td class="price-col">€{{einzelpreis}}</td>
                        <td class="price-col">{{#if rabatt_betrag}}-€{{rabatt_betrag}}{{else}}-{{/if}}</td>
                        <td class="price-col">{{steuersatz}}%</td>
                        <td class="total-col"><strong>€{{zwischensumme}}</strong></td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
        
        <!-- Summary -->
        <div class="summary-section">
            <h3 class="summary-title">Rechnungssumme</h3>
            <table class="summary-table">
                <tr>
                    <td class="summary-label">Warenwert:</td>
                    <td class="summary-value">€{{zusammenfassung.warenwert}}</td>
                </tr>
                {{#if zusammenfassung.rabatte_gesamt}}
                <tr>
                    <td class="summary-label">Rabatte gesamt:</td>
                    <td class="summary-value">-€{{zusammenfassung.rabatte_gesamt}}</td>
                </tr>
                {{/if}}
                <tr>
                    <td class="summary-label">Zwischensumme:</td>
                    <td class="summary-value">€{{zusammenfassung.zwischensumme}}</td>
                </tr>
                <tr>
                    <td class="summary-label">{{versand.bezeichnung}}:</td>
                    <td class="summary-value">€{{versand.kosten}}</td>
                </tr>
                <tr>
                    <td class="summary-label">Netto-Betrag:</td>
                    <td class="summary-value">€{{zusammenfassung.summe_netto}}</td>
                </tr>
                <tr>
                    <td class="summary-label">zzgl. MwSt. (20%):</td>
                    <td class="summary-value">€{{zusammenfassung.ust_20_de}}</td>
                </tr>
                <tr class="summary-total">
                    <td class="summary-label">Rechnungsbetrag:</td>
                    <td class="summary-value">€{{zusammenfassung.summe_brutto}}</td>
                </tr>
            </table>
        </div>
        
        <!-- OSS Information -->
        {{#if oss_hinweis}}
        <div class="oss-section">
            <div class="oss-title">One-Stop-Shop (OSS) Verfahren</div>
            <div class="oss-content">
                {{oss_hinweis.text}}<br>
                <strong>{{oss_hinweis.registrierung}}</strong>
            </div>
        </div>
        {{/if}}
        
        <!-- Shipping & Return Information -->
        <div class="shipping-return-section">
            <div class="info-block">
                <h3>Versand & Lieferung</h3>
                <div class="info-content">
                    <div><strong>Versandart:</strong> {{bestellung.versandart}}</div>
                    <div><strong>Tracking-Nr.:</strong> {{bestellung.tracking}}</div>
                    <div><strong>Voraussichtl. Lieferung:</strong> {{bestellung.voraussichtliche_lieferung}}</div>
                    {{#if versand.tracking_url}}
                    <div style="margin-top: 0.5rem;">
                        <strong>Sendungsverfolgung:</strong><br>
                        {{versand.tracking_url}}
                    </div>
                    {{/if}}
                </div>
            </div>
            <div class="info-block">
                <h3>Rückgabe & Widerruf</h3>
                <div class="info-content">
                    <div><strong>{{retoure.frist}}</strong></div>
                    <div>{{retoure.hinweis}}</div>
                    <div style="margin-top: 0.5rem;">
                        <strong>Retoure-Portal:</strong><br>
                        {{retoure.portal_link}}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>Kundendienst</h4>
                    <div>Telefon: {{kundenservice.hotline}}</div>
                    <div>Zeiten: {{kundenservice.zeiten}}</div>
                    <div>E-Mail: {{kundenservice.email}}</div>
                    {{#if kundenservice.chat}}
                    <div>{{kundenservice.chat}}</div>
                    {{/if}}
                </div>
                <div class="footer-section">
                    <h4>Zahlungsinformationen</h4>
                    <div>{{shop.bank}}</div>
                    <div>IBAN: {{shop.iban}}</div>
                    <div>BIC: {{shop.bic}}</div>
                    <div>Zahlungsziel: 14 Tage netto</div>
                </div>
                <div class="footer-section">
                    <h4>Rechtliche Angaben</h4>
                    <div>{{shop.name}}</div>
                    <div>{{shop.strasse}}</div>
                    <div>{{shop.plz}} {{shop.ort}}, {{shop.land}}</div>
                    <div>UID: {{shop.uid}}</div>
                    <div>{{shop.firmenbuch}}</div>
                    {{#if shop.eori}}<div>EORI: {{shop.eori}}</div>{{/if}}
                    {{#if shop.oss_nummer}}<div>OSS: {{shop.oss_nummer}}</div>{{/if}}
                </div>
                <div class="footer-section">
                    <h4>Zertifizierungen</h4>
                    {{#each shop.gütesiegel}}
                    <div>{{this}}</div>
                    {{/each}}
                    {{#if shop.trustpilot}}
                    <div style="margin-top: 0.5rem;">Trustpilot: {{shop.trustpilot}}</div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</body>
</html>